{"version":3,"sources":["js/helper/CSS3DRenderer.js"],"names":["THREE","CSS3DObject","element","Object3D","call","style","position","addEventListener","parentNode","removeChild","prototype","Object","create","constructor","CSS3DSprite","CSS3DRenderer","_width","_height","_widthHalf","_heightHalf","matrix","Matrix4","cache","camera","fov","objects","WeakMap","domElement","document","createElement","overflow","cameraElement","WebkitTransformStyle","transformStyle","appendChild","isIE","test","navigator","userAgent","epsilon","value","Math","abs","getCameraCSSMatrix","elements","getObjectCSSMatrix","cameraCSSMatrix","matrix3d","getSize","width","height","setSize","getDistanceToSquared","a","b","Vector3","object1","object2","setFromMatrixPosition","matrixWorld","distanceToSquared","zOrder","scene","sorted","filterAndFlatten","result","traverse","object","push","sort","distanceA","get","distanceToCameraSquared","zMax","length","i","l","zIndex","render","projectionMatrix","isPerspectiveCamera","WebkitPerspective","perspective","updateMatrixWorld","parent","isOrthographicCamera","tx","right","left","ty","top","bottom","matrixWorldInverse","WebkitTransform","transform","renderObject","copy","transpose","copyPosition","scale","cachedObject","undefined","objectData","set","children"],"mappings":";AAMAA,MAAMC,YAAc,SAASC,GAC5BF,MAAMG,SAASC,KAAK,MAEfF,KAAAA,QAAUA,EACVA,KAAAA,QAAQG,MAAMC,SAAW,WAEzBC,KAAAA,iBAAiB,UAAW,WACA,OAA5B,KAAKL,QAAQM,YACXN,KAAAA,QAAQM,WAAWC,YAAY,KAAKP,YAK5CF,MAAMC,YAAYS,UAAYC,OAAOC,OAAOZ,MAAMG,SAASO,WAC3DV,MAAMC,YAAYS,UAAUG,YAAcb,MAAMC,YAEhDD,MAAMc,YAAc,SAASZ,GAC5BF,MAAMC,YAAYG,KAAK,KAAMF,IAG9BF,MAAMc,YAAYJ,UAAYC,OAAOC,OAAOZ,MAAMC,YAAYS,WAC9DV,MAAMc,YAAYJ,UAAUG,YAAcb,MAAMc,YAIhDd,MAAMe,cAAgB,WACjBC,IAAAA,EAAQC,EACRC,EAAYC,EAEZC,EAAS,IAAIpB,MAAMqB,QAEnBC,EAAQ,CACXC,OAAQ,CAAEC,IAAK,EAAGnB,MAAO,IACzBoB,QAAS,IAAIC,SAGVC,EAAaC,SAASC,cAAc,OACxCF,EAAWtB,MAAMyB,SAAW,SAEvBH,KAAAA,WAAaA,EAEdI,IAAAA,EAAgBH,SAASC,cAAc,OAE3CE,EAAc1B,MAAM2B,qBAAuB,cAC3CD,EAAc1B,MAAM4B,eAAiB,cAErCN,EAAWO,YAAYH,GAEnBI,IAAAA,EAAO,WAAWC,KAAKC,UAAUC,WAsB5BC,SAAAA,EAAQC,GACTC,OAAAA,KAAKC,IAAIF,GAAS,MAAQ,EAAIA,EAG7BG,SAAAA,EAAmBvB,GACvBwB,IAAAA,EAAWxB,EAAOwB,SAGrB,MAAA,YACAL,EAAQK,EAAS,IACjB,IACAL,GAASK,EAAS,IAClB,IACAL,EAAQK,EAAS,IACjB,IACAL,EAAQK,EAAS,IACjB,IACAL,EAAQK,EAAS,IACjB,IACAL,GAASK,EAAS,IAClB,IACAL,EAAQK,EAAS,IACjB,IACAL,EAAQK,EAAS,IACjB,IACAL,EAAQK,EAAS,IACjB,IACAL,GAASK,EAAS,IAClB,IACAL,EAAQK,EAAS,KACjB,IACAL,EAAQK,EAAS,KACjB,IACAL,EAAQK,EAAS,KACjB,IACAL,GAASK,EAAS,KAClB,IACAL,EAAQK,EAAS,KACjB,IACAL,EAAQK,EAAS,KACjB,IAIOC,SAAAA,EAAmBzB,EAAQ0B,GAC/BF,IAAAA,EAAWxB,EAAOwB,SAClBG,EACH,YACAR,EAAQK,EAAS,IACjB,IACAL,EAAQK,EAAS,IACjB,IACAL,EAAQK,EAAS,IACjB,IACAL,EAAQK,EAAS,IACjB,IACAL,GAASK,EAAS,IAClB,IACAL,GAASK,EAAS,IAClB,IACAL,GAASK,EAAS,IAClB,IACAL,GAASK,EAAS,IAClB,IACAL,EAAQK,EAAS,IACjB,IACAL,EAAQK,EAAS,IACjB,IACAL,EAAQK,EAAS,KACjB,IACAL,EAAQK,EAAS,KACjB,IACAL,EAAQK,EAAS,KACjB,IACAL,EAAQK,EAAS,KACjB,IACAL,EAAQK,EAAS,KACjB,IACAL,EAAQK,EAAS,KACjB,IAEGT,OAAAA,EAEF,iCAEAjB,EACA,MACAC,EACA,MACA2B,EACAC,EAIK,uBAAyBA,EAlH5BC,KAAAA,QAAU,WACP,MAAA,CACNC,MAAOjC,EACPkC,OAAQjC,IAILkC,KAAAA,QAAU,SAASF,EAAOC,GAG9BhC,GAFAF,EAASiC,GAEa,EACtB9B,GAFAF,EAAUiC,GAEc,EAExBvB,EAAWtB,MAAM4C,MAAQA,EAAQ,KACjCtB,EAAWtB,MAAM6C,OAASA,EAAS,KAEnCnB,EAAc1B,MAAM4C,MAAQA,EAAQ,KACpClB,EAAc1B,MAAM6C,OAASA,EAAS,MAuJnCE,IACCC,EACAC,EAFDF,GACCC,EAAI,IAAIrD,MAAMuD,QACdD,EAAI,IAAItD,MAAMuD,QAEX,SAASC,EAASC,GAIjBJ,OAHPA,EAAEK,sBAAsBF,EAAQG,aAChCL,EAAEI,sBAAsBD,EAAQE,aAEzBN,EAAEO,kBAAkBN,KAcpBO,SAAAA,EAAOC,GAUV,IATDC,IAAAA,EAXIC,SAAiBF,GACrBG,IAAAA,EAAS,GAMNA,OAJPH,EAAMI,SAAS,SAASC,GACnBA,aAAkBnE,MAAMC,aAAagE,EAAOG,KAAKD,KAG/CF,EAIMD,CAAiBF,GAAOO,KAAK,SAAShB,EAAGC,GAI9CgB,OAHShD,EAAMG,QAAQ8C,IAAIlB,GAAGmB,wBACrBlD,EAAMG,QAAQ8C,IAAIjB,GAAGkB,0BAKlCC,EAAOV,EAAOW,OAETC,EAAI,EAAGC,EAAIb,EAAOW,OAAQC,EAAIC,EAAGD,IACzCZ,EAAOY,GAAGzE,QAAQG,MAAMwE,OAASJ,EAAOE,EAIrCG,KAAAA,OAAS,SAAShB,EAAOvC,GACzBC,IAAAA,EAAMD,EAAOwD,iBAAiBnC,SAAS,GAAKzB,EAe5CI,GAbAD,EAAMC,OAAOC,MAAQA,IACpBD,EAAOyD,sBACVrD,EAAWtB,MAAM4E,kBAAoBzD,EAAM,KAC3CG,EAAWtB,MAAM6E,YAAc1D,EAAM,MAGtCF,EAAMC,OAAOC,IAAMA,GAGpBsC,EAAMqB,oBAEgB,OAAlB5D,EAAO6D,QAAiB7D,EAAO4D,oBAE/B5D,EAAO8D,qBACNC,IAAAA,IAAO/D,EAAOgE,MAAQhE,EAAOiE,MAAQ,EACrCC,GAAMlE,EAAOmE,IAAMnE,EAAOoE,QAAU,EAGrC7C,IAAAA,EAAkBvB,EAAO8D,qBAC1B,SACA7D,EACA,cAEAe,EAAQ+C,GACR,MACA/C,EAAQkD,GACR,MACA9C,EAAmBpB,EAAOqE,oBAC1B,cACApE,EACA,MACAmB,EAAmBpB,EAAOqE,oBAEzBvF,EACHyC,EACA,aACA5B,EACA,MACAC,EACA,MAEGG,EAAMC,OAAOlB,QAAUA,GAAU8B,IACpCJ,EAAc1B,MAAMwF,gBAAkBxF,EACtC0B,EAAc1B,MAAMyF,UAAYzF,EAEhCiB,EAAMC,OAAOlB,MAAQA,GAxId0F,SAAAA,EAAa5B,EAAQ5C,EAAQuB,GACjCqB,GAAAA,aAAkBnE,MAAMC,YAAa,CACpCI,IAAAA,EAEA8D,aAAkBnE,MAAMc,aAG3BM,EAAO4E,KAAKzE,EAAOqE,oBACnBxE,EAAO6E,YACP7E,EAAO8E,aAAa/B,EAAOR,aAC3BvC,EAAO+E,MAAMhC,EAAOgC,OAEpB/E,EAAOwB,SAAS,GAAK,EACrBxB,EAAOwB,SAAS,GAAK,EACrBxB,EAAOwB,SAAS,IAAM,EACtBxB,EAAOwB,SAAS,IAAM,EAEtBvC,EAAQwC,EAAmBzB,EAAQ0B,IAEnCzC,EAAQwC,EAAmBsB,EAAOR,YAAab,GAG5C5C,IAAAA,EAAUiE,EAAOjE,QACjBkG,EAAe9E,EAAMG,QAAQ8C,IAAIJ,GAEjCiC,QAAiBC,IAAjBD,GAA8BA,EAAa/F,QAAUA,EAAO,CAC/DH,EAAQG,MAAMwF,gBAAkBxF,EAChCH,EAAQG,MAAMyF,UAAYzF,EAEtBiG,IAAAA,EAAa,CAAEjG,MAAOA,GAEtB8B,IACHmE,EAAW9B,wBAA0BpB,EACpC7B,EACA4C,IAIF7C,EAAMG,QAAQ8E,IAAIpC,EAAQmC,GAGvBpG,EAAQM,aAAeuB,GAC1BA,EAAcG,YAAYhC,GAIvB,IAAA,IAAIyE,EAAI,EAAGC,EAAIT,EAAOqC,SAAS9B,OAAQC,EAAIC,EAAGD,IAClDoB,EAAa5B,EAAOqC,SAAS7B,GAAIpD,EAAQuB,GA4F1CiD,CAAajC,EAAOvC,EAAQuB,GAExBX,GAKH0B,EAAOC","file":"CSS3DRenderer.7ae54ca2.js","sourceRoot":"..\\cdnf-card-dict\\gh-pages","sourcesContent":["/**\r\n * Based on http://www.emagix.net/academic/mscs-project/item/camera-sync-with-css3-and-webgl-threejs\r\n * @author mrdoob / http://mrdoob.com/\r\n * @author yomotsu / https://yomotsu.net/\r\n */\r\n\r\nTHREE.CSS3DObject = function(element) {\r\n\tTHREE.Object3D.call(this)\r\n\r\n\tthis.element = element\r\n\tthis.element.style.position = 'absolute'\r\n\r\n\tthis.addEventListener('removed', function() {\r\n\t\tif (this.element.parentNode !== null) {\r\n\t\t\tthis.element.parentNode.removeChild(this.element)\r\n\t\t}\r\n\t})\r\n}\r\n\r\nTHREE.CSS3DObject.prototype = Object.create(THREE.Object3D.prototype)\r\nTHREE.CSS3DObject.prototype.constructor = THREE.CSS3DObject\r\n\r\nTHREE.CSS3DSprite = function(element) {\r\n\tTHREE.CSS3DObject.call(this, element)\r\n}\r\n\r\nTHREE.CSS3DSprite.prototype = Object.create(THREE.CSS3DObject.prototype)\r\nTHREE.CSS3DSprite.prototype.constructor = THREE.CSS3DSprite\r\n\r\n//\r\n\r\nTHREE.CSS3DRenderer = function() {\r\n\tvar _width, _height\r\n\tvar _widthHalf, _heightHalf\r\n\r\n\tvar matrix = new THREE.Matrix4()\r\n\r\n\tvar cache = {\r\n\t\tcamera: { fov: 0, style: '' },\r\n\t\tobjects: new WeakMap()\r\n\t}\r\n\r\n\tvar domElement = document.createElement('div')\r\n\tdomElement.style.overflow = 'hidden'\r\n\r\n\tthis.domElement = domElement\r\n\r\n\tvar cameraElement = document.createElement('div')\r\n\r\n\tcameraElement.style.WebkitTransformStyle = 'preserve-3d'\r\n\tcameraElement.style.transformStyle = 'preserve-3d'\r\n\r\n\tdomElement.appendChild(cameraElement)\r\n\r\n\tvar isIE = /Trident/i.test(navigator.userAgent)\r\n\r\n\tthis.getSize = function() {\r\n\t\treturn {\r\n\t\t\twidth: _width,\r\n\t\t\theight: _height\r\n\t\t}\r\n\t}\r\n\r\n\tthis.setSize = function(width, height) {\r\n\t\t_width = width\r\n\t\t_height = height\r\n\t\t_widthHalf = _width / 2\r\n\t\t_heightHalf = _height / 2\r\n\r\n\t\tdomElement.style.width = width + 'px'\r\n\t\tdomElement.style.height = height + 'px'\r\n\r\n\t\tcameraElement.style.width = width + 'px'\r\n\t\tcameraElement.style.height = height + 'px'\r\n\t}\r\n\r\n\tfunction epsilon(value) {\r\n\t\treturn Math.abs(value) < 1e-10 ? 0 : value\r\n\t}\r\n\r\n\tfunction getCameraCSSMatrix(matrix) {\r\n\t\tvar elements = matrix.elements\r\n\r\n\t\treturn (\r\n\t\t\t'matrix3d(' +\r\n\t\t\tepsilon(elements[0]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(-elements[1]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[2]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[3]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[4]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(-elements[5]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[6]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[7]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[8]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(-elements[9]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[10]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[11]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[12]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(-elements[13]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[14]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[15]) +\r\n\t\t\t')'\r\n\t\t)\r\n\t}\r\n\r\n\tfunction getObjectCSSMatrix(matrix, cameraCSSMatrix) {\r\n\t\tvar elements = matrix.elements\r\n\t\tvar matrix3d =\r\n\t\t\t'matrix3d(' +\r\n\t\t\tepsilon(elements[0]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[1]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[2]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[3]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(-elements[4]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(-elements[5]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(-elements[6]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(-elements[7]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[8]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[9]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[10]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[11]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[12]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[13]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[14]) +\r\n\t\t\t',' +\r\n\t\t\tepsilon(elements[15]) +\r\n\t\t\t')'\r\n\r\n\t\tif (isIE) {\r\n\t\t\treturn (\r\n\t\t\t\t'translate(-50%,-50%)' +\r\n\t\t\t\t'translate(' +\r\n\t\t\t\t_widthHalf +\r\n\t\t\t\t'px,' +\r\n\t\t\t\t_heightHalf +\r\n\t\t\t\t'px)' +\r\n\t\t\t\tcameraCSSMatrix +\r\n\t\t\t\tmatrix3d\r\n\t\t\t)\r\n\t\t}\r\n\r\n\t\treturn 'translate(-50%,-50%)' + matrix3d\r\n\t}\r\n\r\n\tfunction renderObject(object, camera, cameraCSSMatrix) {\r\n\t\tif (object instanceof THREE.CSS3DObject) {\r\n\t\t\tvar style\r\n\r\n\t\t\tif (object instanceof THREE.CSS3DSprite) {\r\n\t\t\t\t// http://swiftcoder.wordpress.com/2008/11/25/constructing-a-billboard-matrix/\r\n\r\n\t\t\t\tmatrix.copy(camera.matrixWorldInverse)\r\n\t\t\t\tmatrix.transpose()\r\n\t\t\t\tmatrix.copyPosition(object.matrixWorld)\r\n\t\t\t\tmatrix.scale(object.scale)\r\n\r\n\t\t\t\tmatrix.elements[3] = 0\r\n\t\t\t\tmatrix.elements[7] = 0\r\n\t\t\t\tmatrix.elements[11] = 0\r\n\t\t\t\tmatrix.elements[15] = 1\r\n\r\n\t\t\t\tstyle = getObjectCSSMatrix(matrix, cameraCSSMatrix)\r\n\t\t\t} else {\r\n\t\t\t\tstyle = getObjectCSSMatrix(object.matrixWorld, cameraCSSMatrix)\r\n\t\t\t}\r\n\r\n\t\t\tvar element = object.element\r\n\t\t\tvar cachedObject = cache.objects.get(object)\r\n\r\n\t\t\tif (cachedObject === undefined || cachedObject.style !== style) {\r\n\t\t\t\telement.style.WebkitTransform = style\r\n\t\t\t\telement.style.transform = style\r\n\r\n\t\t\t\tvar objectData = { style: style }\r\n\r\n\t\t\t\tif (isIE) {\r\n\t\t\t\t\tobjectData.distanceToCameraSquared = getDistanceToSquared(\r\n\t\t\t\t\t\tcamera,\r\n\t\t\t\t\t\tobject\r\n\t\t\t\t\t)\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcache.objects.set(object, objectData)\r\n\t\t\t}\r\n\r\n\t\t\tif (element.parentNode !== cameraElement) {\r\n\t\t\t\tcameraElement.appendChild(element)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (var i = 0, l = object.children.length; i < l; i++) {\r\n\t\t\trenderObject(object.children[i], camera, cameraCSSMatrix)\r\n\t\t}\r\n\t}\r\n\r\n\tvar getDistanceToSquared = (function() {\r\n\t\tvar a = new THREE.Vector3()\r\n\t\tvar b = new THREE.Vector3()\r\n\r\n\t\treturn function(object1, object2) {\r\n\t\t\ta.setFromMatrixPosition(object1.matrixWorld)\r\n\t\t\tb.setFromMatrixPosition(object2.matrixWorld)\r\n\r\n\t\t\treturn a.distanceToSquared(b)\r\n\t\t}\r\n\t})()\r\n\r\n\tfunction filterAndFlatten(scene) {\r\n\t\tvar result = []\r\n\r\n\t\tscene.traverse(function(object) {\r\n\t\t\tif (object instanceof THREE.CSS3DObject) result.push(object)\r\n\t\t})\r\n\r\n\t\treturn result\r\n\t}\r\n\r\n\tfunction zOrder(scene) {\r\n\t\tvar sorted = filterAndFlatten(scene).sort(function(a, b) {\r\n\t\t\tvar distanceA = cache.objects.get(a).distanceToCameraSquared\r\n\t\t\tvar distanceB = cache.objects.get(b).distanceToCameraSquared\r\n\r\n\t\t\treturn distanceA - distanceB\r\n\t\t})\r\n\r\n\t\tvar zMax = sorted.length\r\n\r\n\t\tfor (var i = 0, l = sorted.length; i < l; i++) {\r\n\t\t\tsorted[i].element.style.zIndex = zMax - i\r\n\t\t}\r\n\t}\r\n\r\n\tthis.render = function(scene, camera) {\r\n\t\tvar fov = camera.projectionMatrix.elements[5] * _heightHalf\r\n\r\n\t\tif (cache.camera.fov !== fov) {\r\n\t\t\tif (camera.isPerspectiveCamera) {\r\n\t\t\t\tdomElement.style.WebkitPerspective = fov + 'px'\r\n\t\t\t\tdomElement.style.perspective = fov + 'px'\r\n\t\t\t}\r\n\r\n\t\t\tcache.camera.fov = fov\r\n\t\t}\r\n\r\n\t\tscene.updateMatrixWorld()\r\n\r\n\t\tif (camera.parent === null) camera.updateMatrixWorld()\r\n\r\n\t\tif (camera.isOrthographicCamera) {\r\n\t\t\tvar tx = -(camera.right + camera.left) / 2\r\n\t\t\tvar ty = (camera.top + camera.bottom) / 2\r\n\t\t}\r\n\r\n\t\tvar cameraCSSMatrix = camera.isOrthographicCamera\r\n\t\t\t? 'scale(' +\r\n\t\t\t  fov +\r\n\t\t\t  ')' +\r\n\t\t\t  'translate(' +\r\n\t\t\t  epsilon(tx) +\r\n\t\t\t  'px,' +\r\n\t\t\t  epsilon(ty) +\r\n\t\t\t  'px)' +\r\n\t\t\t  getCameraCSSMatrix(camera.matrixWorldInverse)\r\n\t\t\t: 'translateZ(' +\r\n\t\t\t  fov +\r\n\t\t\t  'px)' +\r\n\t\t\t  getCameraCSSMatrix(camera.matrixWorldInverse)\r\n\r\n\t\tvar style =\r\n\t\t\tcameraCSSMatrix +\r\n\t\t\t'translate(' +\r\n\t\t\t_widthHalf +\r\n\t\t\t'px,' +\r\n\t\t\t_heightHalf +\r\n\t\t\t'px)'\r\n\r\n\t\tif (cache.camera.style !== style && !isIE) {\r\n\t\t\tcameraElement.style.WebkitTransform = style\r\n\t\t\tcameraElement.style.transform = style\r\n\r\n\t\t\tcache.camera.style = style\r\n\t\t}\r\n\r\n\t\trenderObject(scene, camera, cameraCSSMatrix)\r\n\r\n\t\tif (isIE) {\r\n\t\t\t// IE10 and 11 does not support 'preserve-3d'.\r\n\t\t\t// Thus, z-order in 3D will not work.\r\n\t\t\t// We have to calc z-order manually and set CSS z-index for IE.\r\n\t\t\t// FYI: z-index can't handle object intersection\r\n\t\t\tzOrder(scene)\r\n\t\t}\r\n\t}\r\n}\r\n"]}